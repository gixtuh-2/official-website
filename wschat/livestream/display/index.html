<style>
    h1 {
        text-align: center;
    }
    canvas {
        display: none;
    }
    video {
        display: none;
    }
</style>

<h1>Video live streaming using websockets.</h1>
<hr />
<video id="vid"></video>
<img id="img" width="480" height="360" />
<canvas id="canv"></canvas>

<script>
    
    const livestreamnum = prompt("Enter live stream number")
    alert("Share screen to start recording.")
    navigator.mediaDevices.getDisplayMedia({video: true})
        .then(d => {
            const quality = parseFloat(prompt("Quality: ")) || 0.1;
            const ws = new WebSocket("wss://wschat-server.glitch.me")
            ws.onmessage = e => {
                const parsed = JSON.parse(e.data);
                if (parsed.room === `LIVESTREAM${livestreamnum}`) {
                    const img = document.getElementById("img")
                    img.src = parsed.message
                    console.log("hi")
                }
            }

            vid.srcObject = d
            vid.play()

            const ctx = canv.getContext("2d")
            function send() {
                canv.width = vid.videoWidth;
                canv.height = vid.videoHeight;
                ctx.drawImage(vid, 0, 0, canv.width, canv.height);
                const du = canv.toDataURL("image/jpeg", quality);
                ws.send(`{"room":"LIVESTREAM${livestreamnum}","message":"${du}"}`)
            }
            ws.onopen = () => {
                setInterval(send, 100)
            }

        })
    .catch(e => {
        alert(`Error: ${e}\nYou will be receiving data instead of sending it.`)
        const ws = new WebSocket("wss://wschat-server.glitch.me")
        ws.onmessage = e => {
            const parsed = JSON.parse(e.data);
            if (parsed.room === `LIVESTREAM${livestreamnum}`) {
                const img = document.getElementById("img")
                img.src = parsed.message
                console.log("hi")
            }
        }
        ws.onclose = () => {
            alert("Disconnected from websocket server")
            window.location.href = window.location.href
        }

    })
</script>